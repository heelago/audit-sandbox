generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Assignment {
  id                String   @id @default(cuid())
  title             String
  promptText        String
  courseContext      String?
  requirements      String?
  knownPitfalls     String?
  referenceMaterial String?
  sectionBlueprint  String?
  evaluationCriteria String?
  exemplarNotes     String?
  generationStrategy String  @default("natural")
  plannedStudentCount Int?
  plannedStudentCodes String?
  modelVersion      String   @default("claude-sonnet-4-20250514")
  status            String   @default("draft")
  instructorCode    String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  texts             GeneratedText[]
  calibrationLogs   CalibrationLog[]
  analysisReports   AgentAnalysisReport[]

  @@index([instructorCode, createdAt])
}

model GeneratedText {
  id                String   @id @default(cuid())
  assignmentId      String
  studentCode       String
  studentName       String?
  textContent       String
  wordCount         Int
  generationMeta    String?
  difficultyRating  Float?
  rawQualityScore   Float?
  status            String   @default("generated")
  createdAt         DateTime @default(now())

  assignment        Assignment  @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  rubricItems       RubricItem[]
  annotations       Annotation[]
  score             Score?
  analysisReports   AgentAnalysisReport[]

  @@unique([assignmentId, studentCode])
}

model AgentAnalysisReport {
  id                String   @id @default(cuid())
  assignmentId      String
  textId            String
  mode              String
  modelVersion      String?
  summary           String
  findingsCount     Int      @default(0)
  totalsCritical    Int      @default(0)
  totalsModerate    Int      @default(0)
  totalsMinor       Int      @default(0)
  errorCount        Int      @default(0)
  createdAt         DateTime @default(now())

  assignment        Assignment  @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  text              GeneratedText @relation(fields: [textId], references: [id], onDelete: Cascade)
  agentRuns         AgentAnalysisAgentRun[]
  findings          AgentAnalysisFinding[]

  @@index([assignmentId, createdAt])
  @@index([textId, createdAt])
}

model AgentAnalysisAgentRun {
  id                String   @id @default(cuid())
  reportId          String
  agentId           String
  agentName         String
  summary           String
  findingsCount     Int      @default(0)
  error             String?
  createdAt         DateTime @default(now())

  report            AgentAnalysisReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId, createdAt])
}

model AgentAnalysisFinding {
  id                String   @id @default(cuid())
  reportId          String
  passSource        String
  severity          String
  category          String
  description       String
  idealResponse     String?
  flaggedText       String?
  confidence        Float?
  locationStart     Int?
  locationEnd       Int?
  createdAt         DateTime @default(now())

  report            AgentAnalysisReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId, createdAt])
}

model RubricItem {
  id                String   @id @default(cuid())
  textId            String
  passSource        String
  severity          String
  category          String
  locationStart     Int
  locationEnd       Int
  description       String
  idealResponse     String?
  flaggedText       String?
  confirmed         Boolean  @default(true)
  createdAt         DateTime @default(now())

  text              GeneratedText @relation(fields: [textId], references: [id], onDelete: Cascade)
  matches           RubricMatch[]
}

model CalibrationLog {
  id                String   @id @default(cuid())
  assignmentId      String
  action            String
  rubricItemId      String?
  notes             String?
  createdAt         DateTime @default(now())

  assignment        Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
}

model Annotation {
  id                String   @id @default(cuid())
  textId            String
  type              String
  locationStart     Int
  locationEnd       Int
  selectedText      String
  note              String   @default("")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  text              GeneratedText @relation(fields: [textId], references: [id], onDelete: Cascade)
  evidence          Evidence[]
  rubricMatches     RubricMatch[]
  beyondRubric      BeyondRubricFinding?
}

model Evidence {
  id                String   @id @default(cuid())
  annotationId      String
  type              String
  content           String
  createdAt         DateTime @default(now())

  annotation        Annotation @relation(fields: [annotationId], references: [id], onDelete: Cascade)
}

model Score {
  id                String   @id @default(cuid())
  textId            String   @unique
  tier1Raw          Float    @default(0)
  tier2Deductions   Float    @default(0)
  tier3Bonus        Float    @default(0)
  coverageScore     Float    @default(0)
  compositeRaw      Float    @default(0)
  normalizedFinal   Float    @default(0)
  professorAdjusted Boolean  @default(false)
  professorOverride Float?
  professorNotes    String?
  releasedAt        DateTime?
  createdAt         DateTime @default(now())

  text              GeneratedText @relation(fields: [textId], references: [id], onDelete: Cascade)
}

model RubricMatch {
  id                String   @id @default(cuid())
  annotationId      String
  rubricItemId      String
  matchConfidence   String
  matchQuality      Float    @default(0)
  createdAt         DateTime @default(now())

  annotation        Annotation @relation(fields: [annotationId], references: [id], onDelete: Cascade)
  rubricItem        RubricItem @relation(fields: [rubricItemId], references: [id], onDelete: Cascade)
}

model BeyondRubricFinding {
  id                    String   @id @default(cuid())
  annotationId          String   @unique
  aiLegitimacyAssessment String?
  aiQualityAssessment    String?
  professorConfirmed     Boolean?
  professorNotes         String?
  createdAt              DateTime @default(now())

  annotation             Annotation @relation(fields: [annotationId], references: [id], onDelete: Cascade)
}

model AccessRequest {
  id             String   @id @default(cuid())
  fullName       String
  email          String
  institution    String?
  role           String?
  message        String?
  status         String   @default("pending")
  reviewedAt     DateTime?
  reviewedByCode String?
  reviewNotes    String?
  inviteCode     String?
  inviteEmailStatus      String   @default("not_sent")
  inviteEmailAttemptedAt DateTime?
  inviteEmailSentAt      DateTime?
  inviteEmailMessageId   String?
  inviteEmailError       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status, createdAt])
  @@index([email, createdAt])
}

model InstructorAccess {
  id             String   @id @default(cuid())
  code           String   @unique
  fullName       String
  email          String
  institution    String?
  status         String   @default("active")
  createdByCode  String?
  sourceRequestId String?
  lastLoginAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([email, status])
  @@index([status, createdAt])
}
