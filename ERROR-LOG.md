# Error Log

Last updated: 2026-02-24

## Encountered and Resolved

| ID | Area | Symptom | Root Cause | Resolution | Status |
|---|---|---|---|---|---|
| E-001 | Firebase frameworks detection | `Unable to detect the web framework in use.` | Firebase CLI Next detector only checks `next.config.js` or `next.config.mjs`. Repo used `next.config.ts`. | Replaced with `next.config.mjs`. | resolved |
| E-002 | Prisma config typecheck | `datasource is missing` in `prisma.config.ts` | Prisma config engine `classic` requires datasource in config type. | Added datasource URL config with local SQLite fallback for builds without runtime env injection. | resolved |
| E-003 | Firebase CLI state write | `EPERM` writing under `C:\Users\heela\.config` | CLI needs user profile write access; sandbox restrictions blocked it. | Run deploy with elevated permissions in interactive shell. | mitigated |
| E-004 | Firebase deploy packaging (Windows) | `EPERM` symlink while preparing `.firebase/.../functions/.next/node_modules/@prisma/client-*` | Windows symlink/permission behavior during framework packaging. | Bypassed by switching production path to App Hosting deploy (`--only apphosting`). | accepted (non-blocking) |
| E-005 | esbuild lookup during framework packaging | `npx which esbuild` -> `'node-which' is not recognized` | CLI path discovery bug/assumption in this environment. | Treated as Frameworks Hosting-only issue; Path A uses App Hosting and is live. | accepted (non-blocking) |
| E-006 | Local dependency update attempt | `ERR_PNPM_UNEXPECTED_STORE` while adding package | Existing `node_modules` linked to different pnpm store config than current invocation. | Avoided dependency mutation; continued with non-invasive script/documentation path. | resolved |
| E-007 | SQLite export command in restricted shell | `spawn EPERM` running `npm run db:export:sqlite` | `tsx/esbuild` process spawn blocked in sandboxed shell. | Re-ran with elevated permissions; export succeeded. | resolved |
| E-008 | Scripted scoped deploy run | Build succeeds, then fails in framework packaging with `EPERM` symlink + `node-which`/esbuild chain | Firebase framework packaging path in this Windows environment is not stable with current dependency/tooling combination. | Path A chosen; deployment moved to App Hosting. | accepted (non-blocking) |
| E-009 | `apphosting:rollouts:create` failed | `Backend auditsandbox is missing a connected repository` | Rollout command expects GitHub-connected repository for branch/commit rollout. | Switched to local-source App Hosting deploy path (`firebase deploy --only apphosting`) and configured `firebase.json` `apphosting` block. | resolved |
| E-010 | App Hosting build compile failures | Cloud Build failed during Next.js compilation and Prisma client generation | Type issues in API route and Prisma client generation not guaranteed in build context. | Fixed TypeScript route typings/error handling, added `prebuild: prisma generate`, and added SQLite fallback in `prisma.config.ts` for build-time generation. | resolved |
| E-011 | Local sandbox build verification | `next build` failed with `spawn EPERM` in restricted shell | Sandbox execution policy/process spawn limits, not project code. | Re-ran build outside sandbox restrictions; build completed successfully. | resolved |
| E-012 | Production auth endpoint on fresh Postgres | `/api/auth` returned 500 after setting Postgres secret | Prisma schema datasource still configured as `sqlite` and fresh Postgres had no app tables/data yet. | Switched datasource provider to `postgresql` and added guarded error handling in `src/app/api/auth/route.ts`; remaining action is DB bootstrap (`db push` + `seed`) and redeploy. | mitigated |
| E-013 | App Hosting rollout after secret wiring | App Hosting build failed with `Misconfigured Secret` / `secretmanager.versions.get` denied for `DATABASE_URL` | Backend lacked effective IAM access to latest `DATABASE_URL` secret version and `DATABASE_URL` env binding was missing from `apphosting.yaml`. | Added `DATABASE_URL` env binding in `apphosting.yaml`, re-ran `apphosting:secrets:grantaccess`, redeployed successfully. | resolved |
| E-014 | Firebase CLI deploy command false failure on Windows | Deploy output showed successful rollout + live URL, but script threw due non-zero exit code | Firebase CLI update-check/configstore issue (`C:\Users\heela\.config`) can return non-zero even after successful rollout. | Updated deploy scripts to treat rollout as success when logs include both `Rollout ... complete` and `Deploy complete`. | resolved |
| E-015 | Demo deploy config isolation | Needed separate demo backend config (DB + flags) without altering main backend config | Firebase App Hosting CLI deploy uses `apphosting.yaml` at repo root; no direct CLI flag for alternate yaml file. | Demo deploy script now temporarily swaps `apphosting.demo.yaml` into `apphosting.yaml` during demo deploy, then restores original file. | resolved |
| E-016 | Live URL confusion after App Hosting deploy | `/showcase` returned 404 on `h2eapps-auditsandbox.web.app` after successful deploy | App Hosting deploy (`--only apphosting`) serves `*.hosted.app`; `*.web.app` is Firebase Hosting and may not include same rollout. | Standardized verification URL to `https://auditsandbox--h2eapps-unified.us-central1.hosted.app/showcase` after App Hosting deployments. | resolved |
| E-017 | Deploy script not found from `.next` directory | `ERR_PNPM_NO_SCRIPT Missing script: deploy:apphosting` | Deploy command was executed from `...\\auditsandbox\\.next`, where project `package.json` is not the current working directory. | Standardized command usage from repo root (`cd ...\\auditsandbox; pnpm.cmd run deploy:apphosting`) or `pnpm.cmd -C .. run deploy:apphosting` from `.next`. | resolved |
| E-018 | Type strictness in new Gemini analysis flow | `severity` type mismatch (`string` not assignable to `critical|moderate|minor`) during `tsc --noEmit` | Mock rubric generator returns `severity` as generic string. | Added explicit severity normalization in `/api/assignments/[id]/analyze/route.ts`; typecheck now passes. | resolved |
| E-019 | Schema sync command after roster fields added | `prisma db push` failed with `Environment variable not found: DATABASE_URL` | Current local Prisma config skips `.env` loading and active schema provider is `postgresql`; local `.env` still points to sqlite-style dev value and no runtime `DATABASE_URL` was injected in shell. | Code compiles; DB sync deferred. Run `prisma db push` in shell with valid Postgres `DATABASE_URL` exported. | open |
| E-020 | Type errors after schema extension (new assignment fields) | `Property 'referenceMaterial' does not exist on type ...` across assignment routes during `tsc --noEmit` | Prisma schema added new fields but generated Prisma client/types were stale. | Ran `pnpm.cmd prisma generate` and re-ran typecheck; all errors cleared. | resolved |
| E-021 | Local schema sync still blocked in current shell | `prisma db push` failed validation: datasource URL is not `postgresql://`/`postgres://` | Local `DATABASE_URL` value available to shell is not a direct Postgres DSN (protocol not detected), so Prisma cannot connect. | Keep code ready; run DB sync in user shell after exporting the real Supabase Postgres connection string to `DATABASE_URL`. | open |
| E-022 | Repo metadata visibility in this workspace snapshot | `git status` returned `not a git repository` in current shell | Local working copy in this execution context does not expose `.git` metadata. | Continued implementation using file-level verification and `tsc` checks; no git-dependent steps were required for delivery. | accepted (non-blocking) |
| E-023 | Student text API typing after prompt-privacy refactor | `Property 'requirements' does not exist on type ...` during `tsc --noEmit` | `session.role` ternary query produced a union type where student-only fields were not narrowed safely. | Split student/instructor queries into explicit branches in `src/app/api/texts/[id]/route.ts`; typecheck now passes. | resolved |
| E-024 | Demo App Hosting deploy after showcase updates | `Authentication Error: Your credentials are no longer valid` + non-interactive login restriction in agent shell; deploy also showed transient `409 unable to queue the operation` | Firebase CLI token/session expired in this environment, and `firebase login --reauth` cannot run in non-interactive mode from this tool session. | User must run `firebase login --reauth` in local PowerShell, then rerun `pnpm.cmd run deploy:apphosting:demo` from repo root. If rollout is already in progress, wait 2-3 minutes and rerun once. | open |
| E-025 | Local schema push after new access models | `Environment variable not found: DATABASE_URL` on `pnpm prisma db push` | Prisma config in this shell did not have `DATABASE_URL` exported at runtime. | Code and Prisma client generation are complete; run `pnpm prisma db push` in a shell where `DATABASE_URL` is set. | open |
| E-026 | Dependency install in workspace snapshot | `ERR_PNPM_UNEXPECTED_STORE` when adding `firebase-admin` | Workspace `node_modules` was linked to a different pnpm store than current default. | Re-ran install with explicit store dir (`--store-dir C:\\Users\\heela\\AppData\\Local\\pnpm\\store\\v10`); dependency installed successfully. | resolved |
| E-027 | Install retries in restricted shell | `ERR_PNPM_EPERM` download retries and timeout while adding `firebase-admin` | Network-restricted sandbox blocked package download path. | Re-ran same install command with escalated permissions and completed successfully. | resolved |
| E-028 | Onboarding email setup uncertainty | Risk of redoing SMTP/extension setup unnecessarily for this app | Firebase Trigger Email is project-level and was already installed/configured on `h2eapps-unified` with `mail` collection. | Reused existing extension configuration; only app-side integration and admin secret setup were required. | resolved |
| E-029 | Hebrew copy encoding drift in create/onboarding edits | Some user-facing Hebrew strings appeared mojibake in terminal output after iterative edits | Mixed encoding views between shell output and source edits caused uncertainty around UI text correctness. | Replaced/rewrote affected create-page literals and validated source text as UTF-8; no `Ã—` artifacts remain in edited files. | resolved |

| E-030 | Access request CAPTCHA in production | `verification failed` and reCAPTCHA UI error `Invalid domain` on registration form | reCAPTCHA key domain allowlist did not include active production host(s). | Added temporary safe-mode toggle (`ACCESS_REQUEST_RECAPTCHA_DISABLED=1`) so registrations continue while domain allowlist is fixed; preserved non-CAPTCHA abuse controls. | mitigated |
| E-031 | App Hosting rollout failure after security changes | Cloud Build failed with `invalid apphosting.yaml` | `apphosting.yaml` became malformed (trailing secret fragment + wrapped value artifact). | Replaced `apphosting.yaml` and `apphosting.demo.yaml` with clean valid configs and redeployed from corrected files. | resolved |
| E-032 | PowerShell CLI command parsing friction | `Missing expression after unary operator ''--''` and missing argument errors while setting secrets | Commands were pasted in fragments instead of full one-line invocations. | Standardized one-line command format and validated successful `set` + `grantaccess` outputs for secret configuration. | resolved |
| E-033 | Lint script incompatibility on Next.js 16 | `pnpm run lint` fails with `Invalid project directory ...\\lint` | Script uses `next lint`, which is not valid in this CLI behavior/config and is interpreted as path input. | Added QA checklist note; pending script migration to `eslint`-based lint command. | open |
| E-034 | Build finalization on local machine | `next build` compiles but exits with `Error: spawn EPERM` | Local process/permission issue during post-compile build stage in this environment. | Code-level checks pass (`tsc`), added QA checklist; retry build in clean shell after closing orphan Node processes. | open |
## Open Follow-up
1. Validate live auth and assignment flows after rollout.
2. Validate demo backend read-only behavior on mutating flows.
3. Optional later: split demo backend to a dedicated database secret.
4. Continue Postgres cutover phases C/D if importing prior SQLite data is required.

